<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>My Customers | Staff Dashboard</title>

  <!-- THEME -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600&family=Inter&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/remixicon/fonts/remixicon.css" rel="stylesheet">

  <style>
    body {
      font-family: 'Inter', sans-serif;
      background: url("assets/images/bg-beauty.jpg") no-repeat center / cover;
    }
    .brand-title {
      font-family: 'Playfair Display', serif;
    }
  </style>
</head>

<body class="min-h-screen bg-rose-50/80">
<div class="max-w-7xl mx-auto p-6">

  <!-- Header -->
  <div class="mb-6">
    <h1 class="text-2xl font-bold text-rose-700 mb-1">My Customers</h1>
    <p class="text-sm text-gray-600">Manage your assigned customers and their information</p>
  </div>

  <!-- Filters -->
  <div class="bg-white rounded-xl shadow-sm border border-rose-200 p-6 mb-6">
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">

      <!-- Search -->
      <div class="md:col-span-2">
        <label class="block text-sm font-medium text-rose-700 mb-2">Search Customers</label>
        <div class="relative">
          <i class="ri-search-line absolute left-3 top-1/2 -translate-y-1/2 text-rose-400"></i>
          <input id="searchInput" type="text" placeholder="Search by name, email, or phone..."
            class="w-full pl-10 pr-4 py-2 border border-rose-200 rounded-lg focus:ring-2 focus:ring-rose-400 outline-none">
        </div>
      </div>

      <!-- Status -->
      <div>
        <label class="block text-sm font-medium text-rose-700 mb-2">Status</label>
        <select id="statusFilter" class="w-full px-4 py-2 border border-rose-200 rounded-lg cursor-pointer">
          <option value="all">All Status</option>
          <option value="active">Active</option>
          <option value="inactive">Inactive</option>
        </select>
      </div>
    </div>
  </div>

  <!-- Stats -->
  <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
    <div class="bg-white rounded-xl border border-rose-200 p-4">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 bg-rose-500 rounded-lg flex items-center justify-center">
          <i class="ri-user-line text-white text-xl"></i>
        </div>
        <div>
          <p id="totalCustomers" class="text-2xl font-bold text-gray-900">0</p>
          <p class="text-xs text-gray-600">Total Customers</p>
        </div>
      </div>
    </div>

    <div class="bg-white rounded-xl border border-rose-200 p-4">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 bg-green-500 rounded-lg flex items-center justify-center">
          <i class="ri-check-line text-white text-xl"></i>
        </div>
        <div>
          <p id="activeCustomers" class="text-2xl font-bold text-gray-900">0</p>
          <p class="text-xs text-gray-600">Active</p>
        </div>
      </div>
    </div>

    <div class="bg-white rounded-xl border border-rose-200 p-4">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 bg-gray-400 rounded-lg flex items-center justify-center">
          <i class="ri-pause-line text-white text-xl"></i>
        </div>
        <div>
          <p id="inactiveCustomers" class="text-2xl font-bold text-gray-900">0</p>
          <p class="text-xs text-gray-600">Inactive</p>
        </div>
      </div>
    </div>

    <div class="bg-white rounded-xl border border-rose-200 p-4">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 bg-rose-400 rounded-lg flex items-center justify-center">
          <i class="ri-calendar-line text-white text-xl"></i>
        </div>
        <div>
          <p id="upcomingCustomers" class="text-2xl font-bold text-gray-900">0</p>
          <p class="text-xs text-gray-600">Upcoming</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Customer Table -->
  <div class="bg-white rounded-xl shadow-sm border border-rose-200 overflow-hidden">
    <div class="overflow-x-auto">
      <table class="w-full">
        <thead class="bg-rose-50 border-b border-rose-200">
          <tr class="text-xs font-medium text-rose-700 uppercase">
            <th class="px-6 py-3 text-left">Customer</th>
            <th class="px-6 py-3 text-left">Contact</th>
            <th class="px-6 py-3 text-left">Last Visit</th>
            <th class="px-6 py-3 text-left">Next Appointment</th>
            <th class="px-6 py-3 text-left">Treatments</th>
            <th class="px-6 py-3 text-left">Status</th>
            <th class="px-6 py-3 text-left">Actions</th>
          </tr>
        </thead>
        <tbody id="customerTableBody" class="divide-y divide-rose-100"></tbody>
      </table>
    </div>
  </div>

</div>

<!-- Customer Modal -->
<div id="customerModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center p-4 z-50">
  <div class="bg-white rounded-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
    <div class="flex justify-between items-center px-6 py-4 border-b border-rose-200">
      <h3 class="text-xl font-bold text-rose-700">Customer Details</h3>
      <button onclick="closeModal()">
        <i class="ri-close-line text-xl"></i>
      </button>
    </div>

    <div class="p-6 space-y-4">
      <p><strong>Full Name:</strong> <span data-name></span></p>
      <p><strong>Phone:</strong> <input data-phone class="border rounded px-2 py-1 w-full"></p>
      <p><strong>Email:</strong> <span data-email></span></p>
      <p><strong>Medical History:</strong> <span data-medical></span></p>
      <p><strong>Notes:</strong> <textarea data-notes class="border rounded px-2 py-1 w-full"></textarea></p>
      <p><strong>Preferred Date:</strong> <input type="date" data-preferred_date class="border rounded px-2 py-1 w-full"></p>

      <div class="flex gap-3 pt-4">
        <button onclick="saveCustomer()" class="flex-1 px-4 py-2 bg-rose-600 text-white rounded-lg hover:bg-rose-700">
          <i class="ri-save-line mr-2"></i>Save Changes
        </button>
        <button class="flex-1 px-4 py-2 bg-rose-100 text-rose-700 rounded-lg hover:bg-rose-200">
          <i class="ri-calendar-line mr-2"></i>Schedule Appointment
        </button>
      </div>
    </div>
  </div>
</div>

<script>
let currentCustomerId = null;

function openModal(consult_id, customerData) {
  currentCustomerId = consult_id;
  const modal = document.getElementById('customerModal');
  modal.classList.remove('hidden');
  modal.classList.add('flex');

  modal.querySelector('[data-name]').innerText = customerData.full_name;
  modal.querySelector('[data-phone]').value = customerData.phone || '';
  modal.querySelector('[data-email]').innerText = customerData.email || '';
  modal.querySelector('[data-medical]').innerText = customerData.medical_history || '-';
  modal.querySelector('[data-notes]').value = customerData.notes || '';
  modal.querySelector('[data-preferred_date]').value = customerData.preferred_date || '';
}

function closeModal() {
  document.getElementById('customerModal').classList.add('hidden');
}

async function saveCustomer() {
  if (!currentCustomerId) return;

  const modal = document.getElementById('customerModal');
  const updatedCustomer = {
    consult_id: currentCustomerId,
    phone: modal.querySelector('[data-phone]').value,
    notes: modal.querySelector('[data-notes]').value,
    preferred_date: modal.querySelector('[data-preferred_date]').value
  };

  try {
    const res = await fetch('/php/my-customer-update.php', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(updatedCustomer)
    });
    const result = await res.json();

    if (result.success) {
      alert('Customer updated successfully!');
      closeModal();
      loadCustomers();
    } else {
      alert('Failed to update customer.');
    }
  } catch (err) {
    console.error(err);
    alert('Error updating customer.');
  }
}

async function loadCustomers() {
  try {
    const response = await fetch('php/my-customer-fetch.php');
    const data = await response.json();

    const tbody = document.getElementById('customerTableBody');
    tbody.innerHTML = '';

    // Update stats dynamically
    updateStats(data);

    data.forEach(customer => {
      const tr = document.createElement('tr');
      tr.className = 'hover:bg-rose-50';

      tr.innerHTML = `
        <td class="px-6 py-4">
          <div class="flex items-center gap-3">
            <div class="w-10 h-10 rounded-full bg-rose-500 text-white flex items-center justify-center font-bold">
              ${customer.full_name.charAt(0).toUpperCase()}
            </div>
            <div>
              <p class="text-sm font-medium">${customer.full_name}</p>
              <p class="text-xs text-gray-500">${customer.age || ''}, ${customer.gender || ''}</p>
            </div>
          </div>
        </td>
        <td class="px-6 py-4 text-sm">
          ${customer.email || ''}<br>
          <span class="text-gray-500">${customer.phone || ''}</span>
        </td>
        <td class="px-6 py-4 text-sm">${customer.last_visit || '-'}</td>
        <td class="px-6 py-4 text-sm">${customer.preferred_date || '-'}</td>
        <td class="px-6 py-4">
          <span class="px-2 py-1 text-xs rounded-full bg-rose-100 text-rose-700">
            ${customer.treatment_count || '0'} treatments
          </span>
        </td>
        <td class="px-6 py-4">
          <span class="px-2 py-1 text-xs rounded-full ${customer.status === 'inactive' ? 'bg-gray-100 text-gray-700' : 'bg-green-100 text-green-700'}">
            ${customer.status || 'active'}
          </span>
        </td>
        <td class="px-6 py-4">
          <button onclick='openModal(${customer.consult_id}, ${JSON.stringify(customer)})' class="text-rose-600 hover:text-rose-700 font-medium">
            View / Edit
          </button>
        </td>
      `;
      tbody.appendChild(tr);
    });

  } catch (error) {
    console.error('Error loading customers:', error);
  }
}

// Update the stat cards dynamically
function updateStats(customers) {
  const total = customers.length;
  const active = customers.filter(c => c.status === 'active').length;
  const inactive = customers.filter(c => c.status === 'inactive').length;
  const upcoming = customers.filter(c => c.preferred_date && new Date(c.preferred_date) > new Date()).length;

  document.getElementById('totalCustomers').innerText = total;
  document.getElementById('activeCustomers').innerText = active;
  document.getElementById('inactiveCustomers').innerText = inactive;
  document.getElementById('upcomingCustomers').innerText = upcoming;
}

// Filter table
document.getElementById('searchInput').addEventListener('input', filterTable);
document.getElementById('statusFilter').addEventListener('change', filterTable);

function filterTable() {
  const searchTerm = document.getElementById('searchInput').value.toLowerCase();
  const status = document.getElementById('statusFilter').value;

  const rows = document.querySelectorAll('#customerTableBody tr');
  rows.forEach(row => {
    const name = row.querySelector('td div p.font-medium').innerText.toLowerCase();
    const email = row.querySelector('td div p.text-xs').innerText.toLowerCase();
    const phone = row.querySelector('td:nth-child(2)').innerText.toLowerCase();
    const rowStatus = row.querySelector('td:nth-child(6) span').innerText.toLowerCase();

    const matchesSearch = name.includes(searchTerm) || email.includes(searchTerm) || phone.includes(searchTerm);
    const matchesStatus = status === 'all' || rowStatus === status;

    row.style.display = matchesSearch && matchesStatus ? '' : 'none';
  });
}

// Load customers on page load
loadCustomers();
</script>
</body>
</html>
