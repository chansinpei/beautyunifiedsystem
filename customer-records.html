<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Customer Records</title>

<!-- THEME -->
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600&family=Inter&display=swap" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/remixicon/fonts/remixicon.css" rel="stylesheet">

<style>
  body {
    font-family: 'Inter', sans-serif;
    background: url("assets/images/bg-beauty.jpg") no-repeat center / cover;
  }
  .brand-title {
    font-family: 'Playfair Display', serif;
  }
</style>
</head>

<body class="min-h-screen bg-rose-50/80 backdrop-blur">

<div class="max-w-7xl mx-auto px-6 py-8">

  <!-- HEADER -->
  <h1 class="text-3xl font-bold brand-title text-rose-700">
    Customer Records
  </h1>
  <p class="text-gray-600 mt-1">
    Manage and view all customer information securely
  </p>

 <!-- TOP FILTER BAR -->
<div class="flex flex-wrap items-center gap-4 mb-6">

  <!-- Search Bar -->
  <div class="flex-1">
    <input
      type="text"
      id="searchInput"
      placeholder="Search by name, phone, email..."
      class="w-full px-4 py-2 rounded-lg border border-rose-200 focus:ring-2 focus:ring-rose-400 outline-none"
    >
  </div>

  <!-- Status Filter -->
  <select id="statusFilter" class="px-4 py-2 rounded-lg border border-rose-200 text-sm focus:ring-2 focus:ring-rose-400">
    <option>All Status</option>
    <option>Active</option>
    <option>Inactive</option>
  </select>

  <!-- More Filters Button -->
  <button
    onclick="toggleFilters()"
    class="flex items-center gap-2 px-4 py-2 rounded-lg border border-rose-300 text-rose-600 hover:bg-rose-50 transition">
    <i class="ri-filter-3-line text-rose-500"></i>
    More Filters
  </button>

</div>

<!-- MORE FILTERS BAR (HIDDEN BY DEFAULT) -->
<div id="moreFilters" class="hidden bg-white/80 backdrop-blur rounded-xl p-4 mb-6 border border-rose-200">

  <div class="grid grid-cols-1 md:grid-cols-3 gap-6">

    <!-- Age Range -->
    <div>
      <label class="flex items-center gap-2 text-sm font-medium text-rose-700 mb-1">
        <i class="ri-user-line text-rose-500"></i>
        Age Range
      </label>
      <select id="filterAge" class="w-full px-3 py-2 rounded-lg border border-rose-200">
        <option>All Ages</option>
        <option>18 – 25</option>
        <option>26 – 35</option>
        <option>36 – 45</option>
        <option>46+</option>
      </select>
    </div>

    <!-- Last Visit -->
    <div>
      <label class="flex items-center gap-2 text-sm font-medium text-rose-700 mb-1">
        <i class="ri-calendar-line text-rose-500"></i>
        Last Visit
      </label>
      <select id="filterLastVisit" class="w-full px-3 py-2 rounded-lg border border-rose-200">
        <option>All</option>
        <option>Last 7 days</option>
        <option>Last 30 days</option>
        <option>Last 90 days</option>
        <option>Over 90 days</option>
      </select>
    </div>

    <!-- Treatment Count -->
    <div>
      <label class="flex items-center gap-2 text-sm font-medium text-rose-700 mb-1">
        <i class="ri-heart-pulse-line text-rose-500"></i>
        Treatment Count
      </label>
      <select id="filterTreatments" class="w-full px-3 py-2 rounded-lg border border-rose-200">
        <option>All</option>
        <option>1 – 5</option>
        <option>6 – 10</option>
        <option>11 – 20</option>
        <option>20+</option>
      </select>
    </div>

  </div>

  <!-- Actions -->
  <div class="flex justify-end gap-2 pt-2 border-t border-rose-100 mt-4">
    <button onclick="toggleFilters()" class="px-4 py-2 text-sm border border-rose-300 rounded-lg hover:bg-rose-100">Cancel</button>
    <button onclick="applyFilters()" class="px-4 py-2 text-sm bg-rose-600 text-white rounded-lg hover:bg-rose-700">Apply</button>
  </div>
</div>

<!-- TABLE -->
<div class="mt-6 bg-white rounded-xl shadow border border-rose-200 overflow-hidden">
  <table class="w-full">
    <thead class="bg-rose-100">
      <tr>
        <th class="px-6 py-4 text-left text-xs font-semibold text-rose-700 uppercase">Customer Name</th>
        <th class="px-6 py-4 text-left text-xs font-semibold text-rose-700 uppercase">Contact</th>
        <th class="px-6 py-4 text-left text-xs font-semibold text-rose-700 uppercase">Age</th>
        <th class="px-6 py-4 text-left text-xs font-semibold text-rose-700 uppercase">Last Visit</th>
        <th class="px-6 py-4 text-left text-xs font-semibold text-rose-700 uppercase">Treatments</th>
        <th class="px-6 py-4 text-left text-xs font-semibold text-rose-700 uppercase">Status</th>
        <th class="px-6 py-4 text-left text-xs font-semibold text-rose-700 uppercase">Actions</th>
      </tr>
    </thead>
    <tbody id="adminCustomerTableBody" class="divide-y divide-rose-100"></tbody>
  </table>
</div>

<!-- VIEW / EDIT MODAL -->
<div id="viewModal" class="hidden fixed inset-0 bg-black/40 backdrop-blur-sm flex items-center justify-center z-50">
  <div class="bg-white rounded-xl max-w-xl w-full p-6">
    <h2 class="text-xl font-bold brand-title text-rose-700 mb-4">Customer Details</h2>
    <div class="flex items-center gap-4 mb-6">
      <div id="modalInitial" class="w-16 h-16 rounded-full bg-rose-500 text-white flex items-center justify-center text-2xl font-semibold">E</div>
      <div>
        <p id="modalName" class="text-lg font-bold">Emily Chen</p>
        <p id="modalEmail" class="text-gray-500">emily.chen@email.com</p>
      </div>
    </div>

    <div class="grid grid-cols-2 gap-4 text-sm">

      <div>
        <strong>Phone:</strong><br>
        <input id="modalPhone" class="w-full px-2 py-1 border rounded" />
      </div>

      <div>
        <strong>Age:</strong><br>
        <input id="modalAge" class="w-full px-2 py-1 border rounded" readonly />
      </div>

      <div>
        <strong>Last Visit:</strong><br>
        <input id="modalLastVisit" type="date" class="w-full px-2 py-1 border rounded" readonly />
      </div>

      <div>
        <strong>Treatments:</strong><br>
        <input id="modalTreatments" class="w-full px-2 py-1 border rounded" readonly />
      </div>

      <div>
        <strong>Status:</strong><br>
        <select id="modalStatus" class="w-full px-2 py-1 border rounded">
          <option value="active">Active</option>
          <option value="inactive">Inactive</option>
        </select>
      </div>

      <div class="col-span-2">
        <strong>Address:</strong><br>
        <input id="modalAddress" class="w-full px-2 py-1 border rounded" />
      </div>

      <div class="col-span-2">
        <strong>Notes:</strong><br>
        <textarea id="modalNotes" class="w-full px-2 py-1 border rounded"></textarea>
      </div>

    </div>

    <div class="mt-6 flex justify-end gap-3">
      <button onclick="closeView()" class="px-5 py-2 border rounded-lg">Close</button>
      <button id="modalSaveBtn" class="px-5 py-2 bg-rose-600 text-white rounded-lg">Save Changes</button>
    </div>
  </div>
</div>


<script>
const searchInput = document.getElementById('searchInput');
const statusFilter = document.getElementById('statusFilter');
const ageFilter = document.getElementById('filterAge');
const lastVisitFilter = document.getElementById('filterLastVisit');
const treatmentFilter = document.getElementById('filterTreatments');

let adminCustomers = [];

function toggleFilters() {
    document.getElementById('moreFilters').classList.toggle('hidden');
}

// Load customers from DB
async function loadAdminCustomers() {
    try {
        const res = await fetch('php/admin-customer-fetch.php');
        const data = await res.json();

        if (!Array.isArray(data)) {
            console.error('Expected array from fetch, got:', data);
            adminCustomers = [];
        } else {
            adminCustomers = data;
        }

        renderTable(adminCustomers);
    } catch(err) {
        console.error(err);
        adminCustomers = [];
        renderTable(adminCustomers);
    }
}

// Render table
function renderTable(customers) {
    const tbody = document.getElementById('adminCustomerTableBody');
    tbody.innerHTML = '';

    customers.forEach(c => {
        const tr = document.createElement('tr');
        tr.className = 'hover:bg-rose-50';
        tr.innerHTML = `
            <td class="px-6 py-4">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full bg-rose-500 text-white flex items-center justify-center font-semibold">${c.full_name.charAt(0).toUpperCase()}</div>
                    <div><p class="font-medium">${c.full_name}</p><p class="text-xs text-gray-500">${c.email || ''}</p></div>
                </div>
            </td>
            <td class="px-6 py-4">${c.phone || ''}</td>
            <td class="px-6 py-4">${c.age || ''}</td>
            <td class="px-6 py-4">${c.last_visit || '-'}</td>
            <td class="px-6 py-4">${c.treatment_count || 0} visits</td>
            <td class="px-6 py-4">
                <span class="px-3 py-1 rounded-full text-xs ${c.status === 'inactive' ? 'bg-gray-100 text-gray-700' : 'bg-emerald-100 text-emerald-700'}">${c.status || 'active'}</span>
            </td>
            <td class="px-6 py-4 flex gap-2">
                <button class="w-8 h-8 rounded-lg hover:bg-rose-100 view-btn"><i class="ri-eye-line"></i></button>
                <button class="w-8 h-8 rounded-lg hover:bg-rose-100 edit-btn"><i class="ri-edit-line"></i></button>
                <button class="w-8 h-8 rounded-lg hover:bg-red-100 text-red-600 delete-btn"><i class="ri-delete-bin-line"></i></button>
            </td>
        `;

        tr.querySelector('.view-btn').addEventListener('click', ()=>openView(c));
        tr.querySelector('.edit-btn').addEventListener('click', ()=>openView(c));
        tr.querySelector('.delete-btn').addEventListener('click', ()=>deleteCustomer(c.consult_id));

        tbody.appendChild(tr);
    });

    applyFilters();
}

// Filters
function applyFilters() {
    const sText = searchInput.value.toLowerCase();
    const statusText = statusFilter.value.toLowerCase();
    const aFilter = ageFilter.value;
    const lvFilter = lastVisitFilter.value;
    const tFilter = treatmentFilter.value;

    document.querySelectorAll('#adminCustomerTableBody tr').forEach(row => {
        const name = row.cells[0].innerText.toLowerCase();
        const status = row.cells[5].innerText.toLowerCase();
        const age = parseInt(row.cells[2].innerText) || 0;
        const lastVisit = new Date(row.cells[3].innerText);
        const treatments = parseInt(row.cells[4].innerText) || 0;

        let matchAge = true;
        if(aFilter!=='All Ages'){
            if(aFilter==='18 – 25') matchAge=age>=18 && age<=25;
            else if(aFilter==='26 – 35') matchAge=age>=26 && age<=35;
            else if(aFilter==='36 – 45') matchAge=age>=36 && age<=45;
            else if(aFilter==='46+') matchAge=age>=46;
        }

        let matchLV = true;
        const now = new Date();
        if(lvFilter!=='All'){
            const diffDays=(now-lastVisit)/(1000*60*60*24);
            if(lvFilter==='Last 7 days') matchLV=diffDays<=7;
            else if(lvFilter==='Last 30 days') matchLV=diffDays<=30;
            else if(lvFilter==='Last 90 days') matchLV=diffDays<=90;
            else if(lvFilter==='Over 90 days') matchLV=diffDays>90;
        }

        let matchTreat = true;
        if(tFilter!=='All'){
            if(tFilter==='1 – 5') matchTreat=treatments>=1 && treatments<=5;
            else if(tFilter==='6 – 10') matchTreat=treatments>=6 && treatments<=10;
            else if(tFilter==='11 – 20') matchTreat=treatments>=11 && treatments<=20;
            else if(tFilter==='20+') matchTreat=treatments>20;
        }

        const matchSearch = name.includes(sText);
        const matchStatus = statusText==='all status' || status.includes(statusText);

        row.style.display=(matchSearch && matchStatus && matchAge && matchLV && matchTreat)?'':'none';
    });
}

document.querySelectorAll('#moreFilters select').forEach(sel=>sel.addEventListener('change',applyFilters));
searchInput.addEventListener('input',applyFilters);
statusFilter.addEventListener('change',applyFilters);

// Modal
function openView(c){
    document.getElementById('modalInitial').innerText=c.full_name.charAt(0).toUpperCase();
    document.getElementById('modalName').innerText=c.full_name;
    document.getElementById('modalEmail').innerText=c.email || '';
    document.getElementById('modalPhone').value=c.phone || '';
    document.getElementById('modalAge').value=c.age || '';
    document.getElementById('modalLastVisit').value=c.last_visit || '';
    document.getElementById('modalTreatments').value=c.treatment_count || 0;
    document.getElementById('modalStatus').value=c.status || 'active';
    document.getElementById('modalAddress').value=c.address || '';
    document.getElementById('modalNotes').value=c.notes || '';
    document.getElementById('modalSaveBtn').onclick = ()=>saveCustomerChanges(c.consult_id);
    document.getElementById('viewModal').classList.remove('hidden');
}
function closeView(){document.getElementById('viewModal').classList.add('hidden');}

// Delete
async function deleteCustomer(consult_id){
    if(!confirm('Are you sure you want to delete this record?')) return;

    try {
        const res = await fetch('php/admin-customer-delete.php', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ consult_id }) // send correct ID
        });
        const data = await res.json();

        if(data.success){
            alert('Record deleted successfully!');
            loadAdminCustomers(); // refresh table
        } else {
            alert('Delete failed: ' + (data.message || 'Unknown error'));
        }
    } catch(err) {
        console.error(err);
        alert('Delete failed, see console.');
    }
}



// Save
async function saveCustomerChanges(id){
    const updated = {
        consult_id: id,
        phone: document.getElementById('modalPhone').value,
        status: document.getElementById('modalStatus').value,
        address: document.getElementById('modalAddress').value,
        notes: document.getElementById('modalNotes').value
    };
    try{
        const res = await fetch('php/admin-customer-update.php', {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify(updated)
        });
        const r = await res.json();
        if(r.success){
            alert('Customer updated successfully!');
            closeView();
            loadAdminCustomers();
        } else alert('Failed: ' + r.message);
    } catch(err){ console.error(err); }
}

// Initial load
loadAdminCustomers();
</script>

</body>
</html>
